<script>
    // Mock Data for Local Fallback
    const LOCAL_MOCK_DATA = [
        {
            id: '1',
            customerName: 'TechCorp GmbH (Local)',
            contactPerson: 'Julia Müller',
            email: 'julia.mueller@techcorp.de',
            eventDate: '2025-11-15',
            location: 'Berlin',
            status: 'Anfrage'
        },
        {
            id: '2',
            customerName: 'Innovation Summit (Local)',
            contactPerson: 'Max Mustermann',
            email: 'max@innovation-summit.com',
            eventDate: '2026-03-20',
            location: 'München',
            status: 'In Bearbeitung'
        }
    ];

    // Data Service Adapter
    const dataService = {
        getInquiries: async () => {
            return new Promise((resolve, reject) => {
                if (typeof google === 'undefined') {
                    console.warn('GAS environment not detected. Using local mock data.');
                    setTimeout(() => resolve(LOCAL_MOCK_DATA), 500);
                } else {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getInquiries();
                }
            });
        },

        getInquiryById: async (id) => {
            return new Promise((resolve, reject) => {
                if (typeof google === 'undefined') {
                    const item = LOCAL_MOCK_DATA.find(i => i.id === id);
                    setTimeout(() => resolve(item), 200);
                } else {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getInquiryById(id);
                }
            });
        }
    };

    // Application Logic
    document.addEventListener('DOMContentLoaded', () => {
        loadInquiries();
        document.getElementById('refresh-btn')?.addEventListener('click', loadInquiries);
    });

    async function loadInquiries() {
        const listContainer = document.getElementById('inquiries-list');
        listContainer.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 3rem;">Lade Daten...</td></tr>';

        try {
            const inquiries = await dataService.getInquiries();
            renderInquiries(inquiries);
        } catch (error) {
            console.error('Error loading data:', error);
            listContainer.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #ff6b6b; padding: 3rem;">Fehler beim Laden der Daten.</td></tr>';
        }
    }

    function renderInquiries(inquiries) {
        const listContainer = document.getElementById('inquiries-list');

        if (!inquiries || inquiries.length === 0) {
            listContainer.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 3rem;">Keine Anfragen gefunden.</td></tr>';
            return;
        }

        listContainer.innerHTML = inquiries.map(item => `
        <tr>
            <td>
                <div class="customer-cell">${item.customerName}</div>
                <span class="sub-text">${item.contactPerson}</span>
            </td>
            <td>
                <div>${new Date(item.eventDate).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>
                <span class="sub-text">${item.location}</span>
            </td>
            <td>
                ${getStatusBadge(item.status)}
            </td>
            <td>
                <button class="action-btn" onclick="openDetail('${item.id}')" title="Details öffnen">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
            </td>
        </tr>
    `).join('');
    }

    function getStatusBadge(status) {
        let className = 'badge-new';
        if (status && status.includes('Bearbeitung')) className = 'badge-pending';
        if (status && status.includes('Angebot')) className = 'badge-sent';

        return `<span class="badge ${className}">${status || 'Neu'}</span>`;
    }

    // Global function
    window.openDetail = (id) => {
        console.log('Open detail for ID:', id);
        alert('Detail-Ansicht für ID: ' + id + ' folgt in Kürze.');
    };
</script>